---
title: "Data"
author: "Katy Gaythorpe"
date: "`r format(Sys.time(), '%d %B, %Y')`"
header-includes: 
- \usepackage{placeins}
output: 
  pdf_document:
    df_print: "kable"
---

```{r knitsetup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
knitr::opts_chunk$set(
  dev = "png",
  fig.path = "data_images/",
  dpi = 300,
  warning = FALSE,
  message = FALSE
)
```

```{r setup}
library(mcmcplots)
library(ggmcmc)
library(gridExtra)
library(maptools)
library(readr)
library(fields)
library(rgdal)
library(R.utils)
library(magrittr)
library(viridis)
library(ggsci)

library(snapalette)
library(YFestimation)
library(KsetupR)

R.utils::sourceDirectory("Functions", modifiedOnly = FALSE)


#read shapefiles in
shp0 = rgdal::readOGR("../../shapefiles/Africa_SAmerica_0_smooth.shp",
                          stringsAsFactors = FALSE,
                          encoding = "UTF-8",
                          use_iconv = TRUE)
shp1 = rgdal::readOGR("../../shapefiles/Africa_SAmerica_1_smooth.shp",
                          stringsAsFactors = FALSE,
                          encoding = "UTF-8",
                          use_iconv = TRUE)

Env_Table_path = "../Data/Environment/global_dat"

filename = get_latest_file(path = Env_Table_path, pattern = "dat_11")

dat = read.csv(filename, stringsAsFactors = FALSE)

# remove families of NHP that are not to be included
model_form_whole = read.csv("Model_form6.csv", stringsAsFactors = FALSE)$x
covar = unlist(strsplit(unlist(strsplit(model_form_whole, "\\+")), "\\~"))

dat = dat[, -which(!names(dat) %in% covar & grepl("family", names(dat)))] # remove family which are not covariates

# make extra elements and normalise
dat = dplyr::mutate(dat,
                      aggregate_family = rowSums(dat[, grep("family", names(dat))]))
  

dat %<>% filter(!is.na(precip_mean))

covar = c(covar, "aggregate_family")

```


```{r plot_data}

shp1@data %<>% left_join(dat, by = c("GID_1" = "adm1"))
colours = magma(1000)

for(c in covar){
  parm = shp1@data[, c]
  mybreaks = seq(min(parm, na.rm = TRUE) - 1e-5, 
                 max(parm, na.rm = TRUE) + 1e-5, length.out=1001)
  
  mycols =  colours
  vcols = findInterval(shp1@data[, c], mybreaks)
  
  plot(shp0, main = c)
  plot(shp1, col=mycols[vcols] , lty=0, add=TRUE)
  plot(shp0, add=TRUE)
  fields::image.plot(legend.only=TRUE, breaks=mybreaks, col=mycols, zlim=c(0,1), horizontal = TRUE)
  
}

```
