---
title: "Testing model covariates"
author: "Katy Gaythorpe"
date: "`r format(Sys.time(), '%d %B, %Y')`"
header-includes: 
- \usepackage{placeins}
output: 
  pdf_document:
    df_print: "kable"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

library(pROC)
library(KsetupR)
source('Z:/YellowFeverModelEstimation2019/Functions/data_launch.R')
library(dplyr)
library(magrittr)
library(corrplot)
```

```{r load_data}

Env_Table_path = "../Data/Environment/global_dat"

filename = get_latest_file(path = Env_Table_path, pattern = "dat_9")

dat = read.csv(filename, stringsAsFactors = FALSE)

dat = adjust_env_dat(dat)

dat %<>% filter(!is.na(precip_mean))


```

```{r fit models}

covar_to_test = names(dat)[9:(ncol(dat))]

covar_to_test = covar_to_test[grep("surv.qual", covar_to_test, invert = TRUE)]
covar_to_test = covar_to_test[grep("LC_dom", covar_to_test, invert = TRUE)]
covar_to_test = covar_to_test[grep("risk", covar_to_test, invert = TRUE)]
covar_to_test = covar_to_test[grep("population", covar_to_test, invert = TRUE)]

mod = list()
pvalues = rep(NA, length(covar_to_test))
for(i in 1:length(covar_to_test)){
  mod[[i]] = glm( paste0("cases_or_outbreaks~",covar_to_test[i]), 
           data = dat, family=binomial(link="cloglog"))
  
  pvalues[i] = coef(summary(mod[[i]]))[,4]
}

names(pvalues) = covar_to_test

plot(pvalues)

ind_to_keep = which(pvalues < 0.05)

covar_to_test = covar_to_test[ind_to_keep]
```



Look at correlations.

```{r corr, fig.height=12}

cor_out = cor(dat[, covar_to_test])

col2 <- colorRampPalette(c("#67001F", "#B2182B", "#D6604D", "#F4A582",
                           "#FDDBC7", "#FFFFFF", "#D1E5F0", "#92C5DE",
                           "#4393C3", "#2166AC", "#053061"))

corrplot::corrplot(cor_out, col =  col2(7), diag = FALSE, type = "upper")

```

```{r corr2}

tab_cor = cor(dat$cases_or_outbreaks, dat[, covar_to_test])
corrplot::corrplot(tab_cor)

df = data.frame(param = colnames(tab_cor),
                correlation = t(tab_cor))
df %>% arrange(-abs(correlation))

# covar_to_test <- as.character( df$param[abs(df$correlation)>0.1])
# 
# df %<>% filter(param %in% covar_to_test)
```




## Clusters

```{r, fig.height=12, fig.width=10}

x = as.dist( 1-abs(cor(na.omit(
  dat[, covar_to_test]
))))

out =  hclust(x)

plot(
  out
)

parm = list()

ind = 1
for(i in 2:length(covar_to_test)){
  y = cutree(out, k = i)
  
  df$cluster = as.numeric(y[match(names(y), as.character(df$param) )])
  
  df %>% arrange(-abs(correlation))
  
  parm[[ind]] = df %>% 
    arrange(-abs(correlation)) %>% 
    group_by(cluster) %>% 
    summarise(parms = first(param))
  
  ind = ind+1
}



```

# Check fits


```{r fits}
mod = list()
AICs = rep(NA, length(parm))
LLs = rep(NA, length(parm))
for(i in 1:length(parm)){
  
  model_form = paste0("cases_or_outbreaks~", paste(parm[[i]]$parms, collapse = "+") )
  
  mod[[i]] = glm( model_form, data = dat, family=binomial(link="cloglog"))
  AICs[i] = AIC(mod[[i]])
  
  LLs[i] = logLik(mod[[i]])
  
}

par(mfrow = c(1,2))
plot(LLs)
plot(AICs)

parm[[which.min(AICs)]]



```
```{r remove insiginficant}

final_mod = mod[[which.min(AICs)]]

pvalues = coef(summary(final_mod))[,4]

parm = names(pvalues)[pvalues < 0.05]
parm = parm[-1]

model_form = paste0("cases_or_outbreaks~", paste(parm, collapse = "+") )
  
mod = glm( model_form, data = dat, family=binomial(link="cloglog"))


write.csv(data.frame(x = model_form),
                 "Model_form3.csv",
                 row.names = FALSE)
parm
```


# Land cover types

```{r, echo=FALSE}

data.frame( Name = c("Evergreen Needleleaf Forests",
                     "Evergreen Broadleaf Forests",
                     "Deciduous Needleleaf Forests",
                     "Deciduous Broadleaf Forests",
                     "Mixed Forests",
                     "Closed Shrublands",
                     "Open Shrublands",
                     "Woody Savannas",
                     "Savannas",
                     "Grasslands",
                     "Permanent Wetlands",
                     "Croplands",
                     "Urban and Built-up Lands",
                     "Cropland/Natural Vegetation Mosaics",
                     "Permanent Snow and Ice",
                     "Barren",
                     "Water Bodies"),
Landcover = c(1:16, 17) )

```

# Step AIC

```{r stepAIC, eval = FALSE}

dat_subs = select(dat, -c(country,adm0,Province,adm1, 
                          lon, lat , continent , 
                          surv.qual.adm0 , population , 
                          adm05, LC_dom, log.surv.qual.adm0))

library(MASS)

alt_mod = MASS::stepAIC(glm("cases_or_outbreaks~.", data = dat_subs, 
                            family=binomial(link="cloglog")))

alt_mod$formula
```