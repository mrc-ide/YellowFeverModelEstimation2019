---
title: "Model covariates"
author: "Katy Gaythorpe"
date: "`r format(Sys.time(), '%d %B, %Y')`"
header-includes: 
- \usepackage{placeins}
output: 
  pdf_document:
    df_print: "kable"
---

This document outlines the methods used to choose the covariates in the generalised linear model of yellow fever occurrence.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```


```{r libraries}
library(KsetupR)

library(dplyr)
library(magrittr)
library(corrplot)
library(ggplot2)
library(tidyr)
library(caret)
library(MASS)

source('Functions/data_launch.R')
source("Functions/temp_suit.R")
```

We begin by loading the data `dat` which consists of the outcome variable `cases_or_outbreaks` and all the environmental data for each admin one unit.


```{r load_data}

Env_Table_path <- "../Data/Environment/global_dat"

filename <- KsetupR::get_latest_file(path = Env_Table_path, 
                                    pattern = "dat_wes")

dat <- read.csv(filename, stringsAsFactors = FALSE)

# remove missing entries and year column
dat %<>% dplyr::select(-year)
dat %<>% filter( is.finite(MIR.max))
dat %<>% filter(!is.na(temp_mean))
dat %<>% mutate(continent = ifelse(adm0 %in% c("CIV", "STP"),
                                   "Africa", continent)) # check these are assigned properly


#--------------------------------------
# run for only South America
#dat %<>% filter(continent == "Africa") 

#--------------------------------------

# make extra elements and normalise
dat <- adjust_env_dat(dat)

dat[dat==Inf] = NA
dat = dat[, !apply(dat, 2, anyNA)]


```

We may then begin choosing the covariates. First we fetch the list of all covariates and remove those that are highly correlated.

```{r covar_to_test}
covar_to_test <- names(dat)[9:(ncol(dat))]

covar_to_test <- covar_to_test[grep("surv.qual", covar_to_test, invert = TRUE)]
covar_to_test <- covar_to_test[grep("LC_dom", covar_to_test, invert = TRUE)]
covar_to_test <- covar_to_test[grep("risk", covar_to_test, invert = TRUE)]
covar_to_test <- covar_to_test[grep("population", covar_to_test, invert = TRUE)]
covar_to_test <- covar_to_test[grep("aggregate", covar_to_test, invert = TRUE)]
covar_to_test <- covar_to_test[grep("adm05", covar_to_test, invert = TRUE)]
covar_to_test <- covar_to_test[grep("continent", covar_to_test, invert = TRUE)]
covar_to_test <- covar_to_test[grep("dtp", covar_to_test, invert = TRUE)]

as.data.frame(covar_to_test)
```

```{r remove_cor}

# remove very correlated
reduced_dat <-  dat[, covar_to_test]

reduced_dat_cor <-  cor(reduced_dat)

highly_cor <- caret::findCorrelation(reduced_dat_cor, cutoff = .7)

reduced_dat <- reduced_dat[,-highly_cor]

covar_to_test = names(reduced_dat)

as.data.frame(covar_to_test)

```



```{r stepAIC}

dat_subs = dat[, c("cases_or_outbreaks" ,covar_to_test)] # subset again to only columns of interest

#use stepAIC to get list of important covariates
alt_mod = MASS::stepAIC(glm("cases_or_outbreaks~.", data = dat_subs, 
                            family=binomial(link="cloglog")), trace = FALSE)
summary(alt_mod)

# remove those that are not significant
pvalues <- coef(summary(alt_mod))[,4]

parm_out <- names(pvalues)[pvalues < 0.05]
parm_out <- parm_out[-1] # remove intercept

model_form <- paste0("cases_or_outbreaks~", paste(parm_out, collapse = "+") )
  
mod <- glm( model_form, data = dat, family=binomial(link="cloglog"))

as.data.frame(parm_out)

# write.csv(data.frame(x = model_form),
#                  "Model_form_step_2.csv",
#                  row.names = FALSE)

```

```{r add_aggregate}

dat_subs2 = dat_subs[, c("cases_or_outbreaks" ,parm_out)]

dat_subs2 %<>% mutate(aggregate_family = rowSums(dat_subs2[, grep("family", names(dat_subs2))]))

dat_subs2 %<>% dplyr::select(-starts_with("family"))

parm = names(dat_subs2)[-1]

model_form <- paste0("cases_or_outbreaks~", paste(parm, collapse = "+") )
  
mod <- glm( model_form, data = dat, family=binomial(link="cloglog"))

summary(mod)
```

# Land cover types

Here is a reminder of the land cover types and their abbreviations.

```{r, echo=FALSE}

data.frame( Name = c("Evergreen Needleleaf Forests",
                     "Evergreen Broadleaf Forests",
                     "Deciduous Needleleaf Forests",
                     "Deciduous Broadleaf Forests",
                     "Mixed Forests",
                     "Closed Shrublands",
                     "Open Shrublands",
                     "Woody Savannas",
                     "Savannas",
                     "Grasslands",
                     "Permanent Wetlands",
                     "Croplands",
                     "Urban and Built-up Lands",
                     "Cropland/Natural Vegetation Mosaics",
                     "Permanent Snow and Ice",
                     "Barren",
                     "Water Bodies"),
Landcover = c(1:16, 17) )

```